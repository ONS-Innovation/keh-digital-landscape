resource_types:
  - name: key-value
    type: registry-image
    source:
      repository: gstack/keyval-resource

resources:
  - name: resource-repo
    type: git
    icon: github
    source:
      uri: https://github.com/ONS-Innovation/keh-digital-landscape
      username: ((github_access_token))
      password: x-oauth-basic
      branch: ((branch))
  - name: github-release
    type: github-release
    source:
      owner: ONS-Innovation
      repository: keh-digital-landscape
      access_token: ((github_access_token))
  - name: github-release-tag
    type: key-value
    source:
      file: tag-output/tag

# Define the common terraform task as an anchor
terraform-task: &terraform-task
  task: terraform-deploy
  privileged: true
  config:
    platform: linux
    image_resource:
      type: docker-image
      source:
        repository: hashicorp/terraform
    inputs:
      - name: resource-repo
      - name: github-release-tag
    params:
      secrets: ((sdp_((env))_digital_landscape_secrets))
      github_access_token: ((github_access_token))
      env: ((env))
      branch: ((branch))
    run:
      path: sh
      args:
        - -cx
        - |
          echo "DEBUG: Environment is ${env}"
          echo "DEBUG: Tag is ${tag}"
          export tag=$(cat github-release-tag/tag)
          if [[ "$env" == "prod" ]] && [[ "$branch" != "main" && "$branch" != "master" ]]; then
            echo "Not on main branch, skipping terraform for prod."
            exit 0
          fi
          apk add --no-cache jq curl
          if [[ "$env" == "prod" && ! "$tag" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "ERROR: Tag '$tag' is not in semantic versioning format (vX.Y.Z)"
            exit 1
          fi
          chmod u+x ./resource-repo/concourse/scripts/terraform_infra.sh
          ./resource-repo/concourse/scripts/terraform_infra.sh
    timeout: 30m

jobs:
  - name: calculate-tag
    public: true
    plan:
      - get: github-release
        trigger: true
      - get: resource-repo
        trigger: false
      - task: calculate-tag
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: alpine
          inputs:
            - name: resource-repo
            - name: github-release
          outputs:
            - name: tag-output # Output directory for the tag
            - name: built-images # Output directory for built images
          params:
            branch: ((branch))
          run:
            path: sh
            args:
              - -cx
              - |
                apk add --no-cache git
                echo "Calculating tag for branch: ${branch}"
                if [[ "$branch" == "main" || "$branch" == "master" ]]; then
                  # Get the latest tag that matches the format vX.Y.Z
                  tag=$(git -C resource-repo tag --list 'v[0-9]*.[0-9]*.[0-9]*' | sort -V | tail -n 1)
                  if [[ -z "$tag" ]]; then
                    echo "No valid semantic versioning tags (vX.Y.Z) found. Cannot set pipeline."
                    exit 1
                  fi
                else
                  # Remove non-alphanumeric characters and take the first 7 characters
                  tag=$(echo "${branch}" | tr -cd '[:alnum:]' | cut -c1-7)
                fi
                echo "Calculated tag: ${tag}"
                # Write the tag to a file for output
                echo "${tag}" > tag-output/tag
      - put: github-release-tag
        params:
          directory: tag-output

  - name: deploy-after-github-release-dev
    public: true
    plan:
      - get: github-release-tag
        passed: [calculate-tag]
        trigger: true
      - get: resource-repo
        trigger: false
      - task: deploy-release
        privileged: true
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: hashicorp/terraform
          inputs:
            - name: resource-repo
            - name: github-release-tag
          outputs:
            - name: built-images
            - name: release-tag-output
          params:
            aws_account_id: ((aws_account_sdp_dev))
            aws_role_arn: arn:aws:iam::((aws_account_sdp_dev)):role/sdp-concourse-dev
            secrets: ((sdp_dev_digital_landscape_secrets))
            env: dev
            tag: github-release-tag/tag # Use the release tag from the resource
            repo_name: ((repo_name))
          run:
            path: sh
            args:
              - -cx
              - |
                apk add --no-cache aws-cli fuse-overlayfs podman jq iptables curl

                export XDG_RUNTIME_DIR="/tmp/podman-run"
                mkdir -p "$XDG_RUNTIME_DIR"
                export CONTAINERS_STORAGE_CONF="/tmp/containers-storage.conf"
                cat > "$CONTAINERS_STORAGE_CONF" <<'EOF'
                [storage]
                driver = "overlay"
                [storage.options.overlay]
                mount_program = "/usr/bin/fuse-overlayfs"
                EOF

                export repo_name=((repo_name))
                export tag=$(cat github-release-tag/tag)
                # Write the tag to a file for output
                echo "${tag}" > release-tag-output/tag
                echo "Using tag: ${tag}"
                chmod u+x ./resource-repo/concourse/scripts/assume_role.sh
                chmod u+x ./resource-repo/concourse/scripts/build_image.sh
                source ./resource-repo/concourse/scripts/assume_role.sh
                ./resource-repo/concourse/scripts/build_image.sh
                
                # Resolve repos again from secrets (this shell has them)
                mkdir -p built-images
                frontend_repo=$(echo "$secrets" | jq -r .container_image_frontend)
                backend_repo=$(echo "$secrets" | jq -r .container_image_backend)

                if [ -z "$frontend_repo" ] || [ "$frontend_repo" = "null" ]; then
                  echo "ERROR: container_image_frontend missing"; exit 1
                fi
                if [ -z "$backend_repo" ] || [ "$backend_repo" = "null" ]; then
                  echo "ERROR: container_image_backend missing"; exit 1
                fi

                echo "Saving images as tar for next task..."
                podman save "${frontend_repo}:${tag}" -o built-images/frontend.tar
                podman save "${backend_repo}:${tag}" -o built-images/backend.tar
        timeout: 15m
      - task: push-image-to-shared-ecr
        privileged: true
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: hashicorp/terraform
          inputs:
            - name: resource-repo
            - name: github-release-tag
            - name: built-images
          params:
            aws_account_id: ((aws_account_ecr_shared_account))
            aws_role_arn: arn:aws:iam::((aws_account_sdp_dev)):role/sdp-concourse-dev
            secrets: ((sdp_dev_digital_landscape_secrets))
            shared_ecr_folder: keh-digital-landscape
          run:
            path: sh
            args:
              - -cx
              - |
                apk add --no-cache aws-cli fuse-overlayfs podman jq iptables curl

                export XDG_RUNTIME_DIR="/tmp/podman-run"
                mkdir -p "$XDG_RUNTIME_DIR"
                export CONTAINERS_STORAGE_CONF="/tmp/containers-storage.conf"
                cat > "$CONTAINERS_STORAGE_CONF" <<'EOF'
                [storage]
                driver = "vfs"
                EOF

                export repo_name=((repo_name))
                export tag=$(cat github-release-tag/tag)
                # Write the tag to a file for output
                echo "${tag}" > release-tag-output/tag
                echo "Using tag: ${tag}"
                echo "Loading previously built images (tag=${tag})"
                podman load -i built-images/frontend.tar
                podman load -i built-images/backend.tar
                frontend_repo=$(echo "$secrets" | jq -r .container_image_frontend)
                backend_repo=$(echo "$secrets" | jq -r .container_image_backend)
                aws ecr get-login-password --region eu-west-2 | podman login --username AWS --password-stdin ${aws_account_id}.dkr.ecr.eu-west-2.amazonaws.com
                echo "Retagging for shared ECR folder..."
                podman tag "${frontend_repo}:${tag}" "${aws_account_id}.dkr.ecr.eu-west-2.amazonaws.com/${shared_ecr_folder}/${frontend_repo}:${tag}"
                podman tag "${backend_repo}:${tag}" "${aws_account_id}.dkr.ecr.eu-west-2.amazonaws.com/${shared_ecr_folder}/${backend_repo}:${tag}"
                echo "Pushing retagged images..."
                podman push --compression-format=gzip "${aws_account_id}.dkr.ecr.eu-west-2.amazonaws.com/${shared_ecr_folder}/${frontend_repo}:${tag}"
                podman push --compression-format=gzip "${aws_account_id}.dkr.ecr.eu-west-2.amazonaws.com/${shared_ecr_folder}/${backend_repo}:${tag}"
      - <<: *terraform-task
        params:
          github_access_token: ((github_access_token))
          env: dev
          secrets: ((sdp_dev_digital_landscape_secrets))

  - name: release-build-and-push-prod
    public: true
    plan:
      - get: resource-repo
        passed: [deploy-after-github-release-dev]
        trigger: false # Manual trigger only
        timeout: 5m
      - get: github-release-tag
        passed: [deploy-after-github-release-dev]
      - task: build-image
        privileged: true
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: hashicorp/terraform
          inputs:
            - name: resource-repo
            - name: github-release-tag
          params:
            aws_account_id: ((aws_account_sdp_prod))
            aws_role_arn: arn:aws:iam::((aws_account_sdp_prod)):role/sdp-concourse-prod
            secrets: ((sdp_prod_digital_landscape_secrets))
            env: prod
            tag: github-release-tag/tag
            repo_name: ((repo_name))
            branch: ((branch))
          run:
            path: sh
            args:
              - -cx
              - |
                if [[ "$branch" != "main" ]]; then
                  echo "Not on main branch, skipping build."
                  exit 0
                fi
                apk add --no-cache aws-cli podman jq iptables curl
                export repo_name=((repo_name))
                export tag=$(cat github-release-tag/tag)
                echo "Using release tag: ${tag}"
                chmod u+x ./resource-repo/concourse/scripts/assume_role.sh
                chmod u+x ./resource-repo/concourse/scripts/build_image.sh
                source ./resource-repo/concourse/scripts/assume_role.sh
                ./resource-repo/concourse/scripts/build_image.sh
        timeout: 10m
      - <<: *terraform-task
        params:
          github_access_token: ((github_access_token))
          env: prod
          secrets: ((sdp_prod_digital_landscape_secrets))
